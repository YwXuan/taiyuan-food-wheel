<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>å°å…ƒç§‘æŠ€åœ’å€ï½œåˆé¤ç¾é£Ÿè½‰ç›¤ </title>
<meta name="description" content="å°å…ƒç§‘æŠ€åœ’å€ç¾é£Ÿè½‰ç›¤ã€‚æ”¯æ´æœŸåˆ¥ã€ç´ é£Ÿã€é—œéµå­—ã€è·é›¢æ’åº/ä¸Šé™ã€æ–™ç†é¡åˆ¥ã€åƒ¹ä½ç¯©é¸èˆ‡ CSV åŒ¯å‡ºã€‚">
<style>
  :root{--bg:#0f1220;--panel:#171a2b;--card:#1f2340;--text:#e8ecff;--muted:#b6b9d8;--accent:#6ea8fe;--warn:#ffb86b}
  *{box-sizing:border-box}
  body{margin:0;background:radial-gradient(1200px 800px at 20% -20%, #1b2145 0%, #0f1220 60%);color:var(--text);
       font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI","Noto Sans TC","PingFang TC","Helvetica Neue",Arial}
  header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid #2b3054;background:rgba(0,0,0,.2);backdrop-filter: blur(6px);position:sticky;top:0;z-index:10}
  header h1{margin:0;font-size:18px}.sub{color:var(--muted);font-size:12px}
  main{display:grid;grid-template-columns:340px 1fr;gap:12px;padding:12px;max-width:1200px;margin:0 auto}
  @media (max-width: 900px){ main{grid-template-columns:1fr} }
  .panel{background:var(--panel);border:1px solid #2b3054;border-radius:14px;padding:12px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .panel h2{margin:6px 0 8px;font-size:16px}
  .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid #2b3054;background:#21264a;color:var(--text);
       padding:8px 12px;border-radius:10px;cursor:pointer;font-size:14px;transition:.15s transform ease,.15s box-shadow ease}
  .btn:hover{transform:translateY(-1px);box-shadow:0 8px 16px rgba(0,0,0,.25)}
  .btn.primary{background:linear-gradient(135deg,#3b5bff,#6ea8fe);border-color:transparent}
  .btn.small{font-size:12px;padding:6px 10px}
  .chips{display:flex;flex-wrap:wrap;gap:8px}.chip{padding:6px 10px;border:1px solid #2b3054;border-radius:999px;color:var(--muted);cursor:pointer}
  .chip.active{background:#2b3054;color:var(--text)}
  .muted{color:var(--muted)} .stack{display:flex;gap:8px;flex-wrap:wrap} .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .grid{display:grid;grid-template-columns:1.1fr 1fr;gap:12px} @media (max-width: 900px){.grid{grid-template-columns:1fr}}
  #wheelCanvas{width:min(90vw,560px);height:min(90vw,560px);background:conic-gradient(from 0deg,#1b1f3a,#252a52);
               border-radius:50%;border:10px solid #2b3054;box-shadow:inset 0 0 80px rgba(0,0,0,.3),0 20px 40px rgba(0,0,0,.35)}
  .pointer{width:0;height:0;border-left:14px solid transparent;border-right:14px solid transparent;border-bottom:22px solid var(--warn);filter:drop-shadow(0 3px 0 rgba(0,0,0,.4));margin-top:-6px}
  table{width:100%;border-collapse:collapse;font-size:13px} th,td{padding:8px 10px;border-bottom:1px dashed #2b3054;text-align:left}
  th{color:#cbd0ff} .phase{padding:.15em .5em;border-radius:999px;background:#2b3054}
  footer{padding:14px;text-align:center;color:#8085b0}
  input[type="search"],select,input[type="number"]{padding:8px 10px;border-radius:8px;border:1px solid #2b3054;background:#121633;color:#e8ecff}
  input[type="range"]{width:100%}
  .tag{display:inline-flex;align-items:center;gap:6px;padding:.18rem .5rem;border-radius:999px;border:1px solid #2b3054;color:#cbd0ff;font-size:12px}
  .card{background:var(--card);border:1px solid #2b3054;border-radius:10px;padding:10px}
</style>
</head>
<body>
<header>
  <div>
    <h1>å°å…ƒç§‘æŠ€åœ’å€ï½œåˆé¤ç¾é£Ÿè½‰ç›¤</h1>
    <div class="sub">æ”¯æ´è·é›¢ / æ–™ç†é¡åˆ¥ / åƒ¹ä½ç¯©é¸</div>
  </div>
  <div class="stack">
    <button class="btn small" id="btnExport">åŒ¯å‡º CSV</button>
    <button class="btn small" id="btnReset">é‡è¨­</button>
  </div>
</header>

<main>
  <aside class="panel">
    <h2>ç¯©é¸</h2>
    <div class="row"><div class="muted">æœŸåˆ¥</div><div class="chips" id="phaseChips"></div></div>
    <div class="row" style="margin-top:6px">
      <label class="row"><input type="checkbox" id="onlyMeals"> åªçœ‹æ­£é¤</label>
      <label class="row"><input type="checkbox" id="onlyVeg"> å¯ç´ é£Ÿ</label>
    </div>
    <div class="row" style="margin-top:6px">
      <select id="cat">
        <option value="">æ–™ç†é¡åˆ¥ï¼ˆå…¨éƒ¨ï¼‰</option>
        <option>å°å¼</option><option>ä¾¿ç•¶</option><option>éºµé£Ÿ</option><option>æ‹‰éºµ</option>
        <option>éŸ“å¼</option><option>å’–å“©</option><option>ç´ é£Ÿ</option><option>è¼•é£Ÿ</option>
        <option>ç‚¸ç‰©</option><option>å’–å•¡</option><option>æ—©é¤</option><option>é£²æ–™</option><option>æœæ±</option>
      </select>
      <select id="price">
        <option value="">åƒ¹ä½ï¼ˆå…¨éƒ¨ï¼‰</option>
        <option>$</option><option>$$</option><option>$$$</option>
      </select>
    </div>
    <div style="margin-top:6px" class="row">
      <input id="q" type="search" placeholder="é—œéµå­—ï¼ˆå¦‚ å’–å“© / ä¾¿ç•¶ / SUBWAYï¼‰" style="flex:1">
      <button class="btn" id="btnApply">å¥—ç”¨</button>
    </div>
    <hr style="border-color:#2b3054;border-style:solid;border-width:1px 0 0;margin:12px 0">
    <h2>è·é›¢</h2>
    <div class="row">
      <button class="btn small" id="btnUseGPS">ç”¨ç›®å‰ä½ç½®</button>
      <select id="myPhase">
        <option value="">æˆ–é¸æˆ‘çš„æœŸåˆ¥ç•¶èµ·é»</option>
        <option value="1">1 æœŸ ä¸€æœŸè±ªè¯å•†å‹™æœƒé¤¨</option>
        <option value="2">2 æœŸ Mini Mart</option>
        <option value="3">3 æœŸ Food Center / æ–‡åŒ–æœƒé¤¨</option>
        <option value="5">5 æœŸ åä»•å¥èº«æœƒé¤¨</option>
        <option value="6">6 æœŸ å°å…ƒäºŒè¡—1è™Ÿ</option>
        <option value="8">8 æœŸ W æœƒé¤¨</option>
        <option value="9">9 æœŸ Z æ£Ÿ</option>
      </select>
    </div>
    <div class="row" style="margin-top:6px">
      <div class="muted" style="min-width:5em">ä¸Šé™</div>
      <input type="range" id="maxDist" min="100" max="1200" step="50" value="1200">
      <span id="maxDistLabel" class="muted">â‰¤ 1200 m</span>
    </div>
    <div class="row" style="margin-top:6px">
      <div class="muted" style="min-width:5em">æ’åº</div>
      <select id="sortBy">
        <option value="distance">è·é›¢ï¼ˆè¿‘â†’é ï¼‰</option>
        <option value="name">åç¨±ï¼ˆAâ†’Zï¼‰</option>
        <option value="phase">æœŸåˆ¥ï¼ˆå°â†’å¤§ï¼‰</option>
      </select>
    </div>
    <div class="card" style="margin-top:8px">
      <div class="muted" id="myLocLabel">èµ·é»ï¼šæœªè¨­å®šï¼ˆè·é›¢æ’åºåŠŸèƒ½å—é™ï¼‰</div>
      <div class="muted" style="margin-top:4px">æé†’ï¼šè‹¥ç”¨ <code>file://</code> é–‹å•Ÿï¼ŒGPS å¯èƒ½è¢«æ“‹ï¼›ç”¨ GitHub Pages / Netlifyï¼ˆHTTPSï¼‰å³å¯ã€‚</div>
    </div>
  </aside>

  <section class="grid">
    <div class="panel">
      <div style="display:grid;place-items:center;gap:8px">
        <canvas id="wheelCanvas" width="560" height="560"></canvas>
        <div class="pointer"></div>
        <div class="stack">
          <button class="btn primary" id="btnSpin">ğŸ¯ é–‹æŠ½ï¼</button>
          <button class="btn" id="btnShuffle">é‡æ–°æ´—ç‰Œ</button>
        </div>
        <div id="result" class="muted">æŒ‰ã€Œé–‹æŠ½ï¼ã€é–‹å§‹è½‰ç›¤</div>
      </div>
    </div>
    <div class="panel">
      <div class="row" style="justify-content:space-between">
        <strong>ç›®å‰å€™é¸åå–®</strong>
        <div class="tag" id="countRow">â€”</div>
      </div>
      <div class="card" style="max-height:420px;overflow:auto;margin-top:8px">
        <table id="listTbl"><thead><tr><th>é¤å»³</th><th>æœŸ</th><th>åœ°å€</th><th>é¡å‹</th><th>é¡åˆ¥</th><th>åƒ¹ä½</th><th>è·é›¢</th></tr></thead><tbody></tbody></table>
      </div>
    </div>
  </section>
</main>

<footer>ä¾†æºï¼šå°å…ƒç§‘æŠ€åœ’å€ã€Œåœ’å€åº—å®¶ã€å®˜æ–¹åˆ—è¡¨ï¼ˆæœŸåˆ¥é¤¨ï¼‰ã€‚è·é›¢ç‚ºè¿‘ä¼¼ä¼°ç®—ï¼ˆä»¥æœŸåˆ¥ä¸­å¿ƒé»ä»£è¡¨ä½ç½®ï¼‰ã€‚</footer>

<script>
// === Phase ä¸­å¿ƒé»ï¼ˆè¿‘ä¼¼ï¼‰ ===
const phaseCenters = {
  1:[24.8289,121.0168], 2:[24.8296,121.0179], 3:[24.8298,121.0148],
  5:[24.8307,121.0134], 6:[24.8309,121.0170], 8:[24.8292,121.0198], 9:[24.8297,121.0215],
};

// === é¤å»³è³‡æ–™ï¼ˆæ–°å¢ cat, priceï¼‰===
const DATA = [
  // 1 æœŸ
  {name:"é•·é®®èˆ’è‚¥å»šæˆ¿", phase:1, addr:"å°å…ƒè¡—26-6è™Ÿ(ä¸€æœŸè±ªè¯å•†å‹™æœƒé¤¨)", type:"æ­£é¤", veg:false, cat:"å°å¼", price:"$$"},
  {name:"cama cafe å°å…ƒç§‘æŠ€åº—", phase:1, addr:"å°å…ƒè¡—26-9è™Ÿä¹‹2(ä¸€æœŸè±ªè¯å•†å‹™æœƒé¤¨)", type:"å’–å•¡", veg:false, cat:"å’–å•¡", price:"$"},
  {name:"åº·é’é¾ å°å…ƒåº—", phase:1, addr:"å°å…ƒè¡—26-9è™Ÿä¹‹1(ä¸€æœŸè±ªè¯å•†å‹™æœƒé¤¨)", type:"é£²æ–™", veg:false, cat:"é£²æ–™", price:"$"},
  {name:"ç¾è€Œç¾ å°å…ƒåº—", phase:1, addr:"å°å…ƒè¡—26-9è™Ÿä¹‹1(ä¸€æœŸè±ªè¯å•†å‹™æœƒé¤¨)", type:"æ—©é¤", veg:false, cat:"æ—©é¤", price:"$"},
  {name:"SUBWAY å°å…ƒä¸€åº—", phase:1, addr:"å°å…ƒè¡—26-11è™Ÿ(ä¸€æœŸè±ªè¯å•†å‹™æœƒé¤¨1æ¨“)", type:"è¼•é£Ÿ", veg:true, cat:"è¼•é£Ÿ", price:"$"},
  {name:"æºå£«æ—ç²¥å“", phase:1, addr:"å°å…ƒè¡—26è™Ÿ2æ¨“(ä¸€æœŸè±ªè¯å•†å‹™æœƒé¤¨)", type:"æ­£é¤", veg:false, cat:"å°å¼", price:"$"},
  {name:"å“åœ“", phase:1, addr:"å°å…ƒè¡—26è™Ÿ2æ¨“(ä¸€æœŸè±ªè¯å•†å‹™æœƒé¤¨)", type:"æ­£é¤", veg:false, cat:"å°å¼", price:"$"},
  {name:"æ‹¾ç³§ è”¬é£Ÿæ–™ç†", phase:1, addr:"å°å…ƒè¡—26è™Ÿ2æ¨“(ä¸€æœŸè±ªè¯å•†å‹™æœƒé¤¨)", type:"ç´ é£Ÿ", veg:true, cat:"ç´ é£Ÿ", price:"$"},
  {name:"çš‡æ¨“ç‡’è‡˜", phase:1, addr:"å°å…ƒè¡—26è™Ÿ2æ¨“(ä¸€æœŸè±ªè¯å•†å‹™æœƒé¤¨)", type:"æ­£é¤", veg:false, cat:"ä¾¿ç•¶", price:"$"},
  {name:"ä¸‰å–œå±‹", phase:1, addr:"å°å…ƒè¡—26è™Ÿ2æ¨“(ä¸€æœŸè±ªè¯å•†å‹™æœƒé¤¨)", type:"æ­£é¤", veg:false, cat:"å°å¼", price:"$"},
  // 2 æœŸ
  {name:"æ˜Ÿå·´å…‹ å°å…ƒé–€å¸‚", phase:2, addr:"å°å…ƒè¡—34è™Ÿ(äºŒæœŸæœƒé¤¨)", type:"å’–å•¡", veg:false, cat:"å’–å•¡", price:"$"},
  {name:"é¼è±åœ’", phase:2, addr:"å°å…ƒè¡—34è™Ÿ(Mini Mart)", type:"æ­£é¤", veg:false, cat:"å°å¼", price:"$$"},
  {name:"æ‰¿é‹ä¸–å®¶", phase:2, addr:"å°å…ƒè¡—34è™Ÿ(Mini Mart)", type:"æ­£é¤", veg:false, cat:"å°å¼", price:"$"},
  {name:"å¥½å‘·å‘³é£Ÿå ‚", phase:2, addr:"å°å…ƒè¡—34è™Ÿ(Mini Mart)", type:"æ­£é¤", veg:false, cat:"å°å¼", price:"$"},
  // 3 æœŸ
  {name:"ä¸‰å•†å·§ç¦", phase:3, addr:"å°å…ƒä¸€è¡—7è™Ÿ(ä¸‰æœŸ Food Center)", type:"æ­£é¤", veg:false, cat:"å°å¼", price:"$"},
  {name:"å…«æ–¹é›²é›†ï¼ˆä¸‰æœŸï¼‰", phase:3, addr:"å°å…ƒä¸€è¡—7è™Ÿ(ä¸‰æœŸ Food Center)", type:"æ­£é¤", veg:false, cat:"éºµé£Ÿ", price:"$"},
  {name:"éŸ“åœ‹é¤¨", phase:3, addr:"å°å…ƒä¸€è¡—7è™Ÿ(ä¸‰æœŸ Food Center)", type:"æ­£é¤", veg:false, cat:"éŸ“å¼", price:"$$"},
  {name:"å¦™è“®ç´ é£Ÿ", phase:3, addr:"å°å…ƒä¸€è¡—7è™Ÿ(ä¸‰æœŸ Food Center)", type:"ç´ é£Ÿ", veg:true, cat:"ç´ é£Ÿ", price:"$"},
  {name:"æ¦®èŒ‚é­¯è‚‰é£¯", phase:3, addr:"å°å…ƒä¸€è¡—7è™Ÿ(ä¸‰æœŸ Food Center)", type:"æ­£é¤", veg:false, cat:"ä¾¿ç•¶", price:"$"},
  {name:"ç‚¸é›å¤§ç…", phase:3, addr:"å°å…ƒä¸€è¡—7è™Ÿ(ä¸‰æœŸ Food Center)", type:"ç‚¸ç‰©", veg:false, cat:"ç‚¸ç‰©", price:"$"},
  {name:"é‡‘é›²å¤§é¤›é£©", phase:3, addr:"å°å…ƒä¸€è¡—7è™Ÿ(ä¸‰æœŸ Food Center)", type:"éºµé£Ÿ", veg:false, cat:"éºµé£Ÿ", price:"$"},
  {name:"The Greenery è”¬åŠ", phase:3, addr:"å°å…ƒä¸€è¡—7è™Ÿ(ä¸‰æœŸ Food Center)", type:"è¼•é£Ÿ", veg:true, cat:"è¼•é£Ÿ", price:"$"},
  {name:"85åº¦C ç«¹åŒ—å°å…ƒåº—", phase:3, addr:"å°å…ƒä¸€è¡—7è™Ÿ(ä¸‰æœŸ Food Center)", type:"å’–å•¡", veg:false, cat:"å’–å•¡", price:"$"},
  {name:"SUBWAY å°å…ƒåº—ï¼ˆä¸‰æœŸï¼‰", phase:3, addr:"å°å…ƒä¸€è¡—3è™Ÿä¹‹1(ä¸‰æœŸæ–‡åŒ–æœƒé¤¨)", type:"è¼•é£Ÿ", veg:true, cat:"è¼•é£Ÿ", price:"$"},
  {name:"èƒèŒ¶é¢¨ å¤§äº«é£Ÿ", phase:3, addr:"å°å…ƒä¸€è¡—3è™Ÿ(ä¸‰æœŸæ–‡åŒ–æœƒé¤¨)", type:"ä¸¼é£¯/çƒé¾éºµ", veg:false, cat:"å°å¼", price:"$"},
  // 5 æœŸ
  {name:"SABROSA èŠ±åœ’é¤å»³", phase:5, addr:"å°å…ƒä¸€è¡—2è™Ÿ(äº”æœŸæœƒé¤¨)", type:"æ­£é¤", veg:false, cat:"è¥¿å¼", price:"$$$"},
  {name:"æ˜Ÿå·´å…‹ å°å…ƒäºŒé–€å¸‚", phase:5, addr:"å°å…ƒä¸€è¡—2è™Ÿ(äº”æœŸæœƒé¤¨)", type:"å’–å•¡", veg:false, cat:"å’–å•¡", price:"$"},
  // 6 æœŸ
  {name:"äº”èŠ±é¦¬æ°´é¤ƒé¤¨", phase:6, addr:"å°å…ƒäºŒè¡—1è™Ÿ2æ¨“(å…­æœŸ)", type:"éºµé£Ÿ", veg:false, cat:"éºµé£Ÿ", price:"$"},
  // 8 æœŸ
  {name:"æ¢ç¤¾æ¼¢æ’éª¨", phase:8, addr:"å°å…ƒäºŒè¡—7è™Ÿ1æ¨“(å…«æœŸ W æœƒé¤¨)", type:"ä¾¿ç•¶", veg:false, cat:"ä¾¿ç•¶", price:"$"},
  {name:"ç†Šç¦¾å±‹æ—¥å¼å’–å“©", phase:8, addr:"å°å…ƒäºŒè¡—7è™Ÿ1æ¨“(å…«æœŸ W æœƒé¤¨)", type:"å’–å“©", veg:false, cat:"å’–å“©", price:"$"},
  {name:"å…«æ–¹é›²é›†ï¼ˆå…«æœŸï¼‰", phase:8, addr:"å°å…ƒäºŒè¡—7è™Ÿ1æ¨“(å…«æœŸ W æœƒé¤¨)", type:"æ­£é¤", veg:false, cat:"éºµé£Ÿ", price:"$"},
  {name:"æ¦®ç›Šé›è‚‰é£¯", phase:8, addr:"å°å…ƒäºŒè¡—7è™Ÿ1æ¨“(å…«æœŸ W æœƒé¤¨)", type:"ä¾¿ç•¶", veg:false, cat:"ä¾¿ç•¶", price:"$"},
  // 9 æœŸ
  {name:"æ‚ é®®æœç‰©", phase:9, addr:"å°å…ƒäºŒè¡—16è™Ÿ1æ¨“(ä¹æœŸ Z æ£Ÿ)", type:"æœæ±/è¼•é£Ÿ", veg:true, cat:"æœæ±", price:"$"},
  {name:"æ»ç¦¾è£½éºµæ‰€ï¼ˆä¹æœŸï¼‰", phase:9, addr:"å°å…ƒäºŒè¡—16è™Ÿ1æ¨“(ä¹æœŸ Z æ£Ÿ)", type:"æ‹‰éºµ", veg:false, cat:"æ‹‰éºµ", price:"$$"},
  {name:"æœæ­£æ³° å—æ´‹æ–™ç†", phase:9, addr:"å°å…ƒäºŒè¡—16è™Ÿ1æ¨“(ä¹æœŸ Z æ£Ÿ)", type:"å—æ´‹", veg:false, cat:"å’–å“©", price:"$$"},
  {name:"å››æµ·éŠé¾ï¼ˆä¹æœŸï¼‰", phase:9, addr:"å°å…ƒäºŒè¡—16è™Ÿ1æ¨“(ä¹æœŸ Z æ£Ÿ)", type:"é‹è²¼/æ°´é¤ƒ", veg:false, cat:"éºµé£Ÿ", price:"$"},
  {name:"è±ç±³ä¾¿ç•¶ï¼ˆä¹æœŸï¼‰", phase:9, addr:"å°å…ƒäºŒè¡—16è™Ÿ1æ¨“(ä¹æœŸ Z æ£Ÿ)", type:"ä¾¿ç•¶", veg:false, cat:"ä¾¿ç•¶", price:"$"},
];

// === ç‹€æ…‹ ===
let state={ phases:new Set([1,2,3,5,6,8,9]), onlyMeals:false, onlyVeg:false, cat:"", price:"", myLoc:null, maxDist:1200, sortBy:"distance" };

// === è·é›¢å·¥å…· ===
const toRad=d=>d*Math.PI/180;
function haversine(a,b){ if(!a||!b) return null; const [lat1,lon1]=a,[lat2,lon2]=b; const R=6371000;
  const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
  const s=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(s));
}
const asMeters=m=>m==null?"â€”":(m<1000?`${Math.round(m)} m`:`${(m/1000).toFixed(2)} km`);

// === è³‡æ–™éæ¿¾ ===
function getFiltered(){
  const q=document.getElementById('q').value.trim();
  const words=q? q.split(/\s+/):[];
  let arr=DATA.filter(d=>state.phases.has(d.phase))
              .filter(d=>!state.onlyMeals || (d.type!=="å’–å•¡"&&d.type!=="é£²æ–™"&&d.type!=="ç”œé»"&&d.type!=="æœæ±/è¼•é£Ÿ"&&d.type!=="æ—©é¤"))
              .filter(d=>!state.onlyVeg || d.veg)
              .filter(d=>!state.cat || d.cat===state.cat)
              .filter(d=>!state.price || d.price===state.price)
              .filter(d=>!words.length || words.every(w=>(d.name+d.addr+d.type+d.cat).includes(w)))
              .map(d=>({...d, coord:phaseCenters[d.phase]}));
  arr=arr.map(d=>({...d, dist: state.myLoc&&d.coord? haversine(state.myLoc,d.coord):null}));
  if(state.myLoc){ arr=arr.filter(d=>d.dist==null || d.dist<=state.maxDist); }
  if(state.sortBy==='distance'){ arr.sort((a,b)=>(a.dist??1e15)-(b.dist??1e15)); }
  else if(state.sortBy==='name'){ arr.sort((a,b)=>a.name.localeCompare(b.name,'zh-Hant')); }
  else if(state.sortBy==='phase'){ arr.sort((a,b)=>a.phase-b.phase || a.name.localeCompare(b.name,'zh-Hant')); }
  return arr;
}

// === UI ===
function renderPhaseChips(){
  const host=document.getElementById('phaseChips'); host.innerHTML='';
  [1,2,3,5,6,8,9].forEach(p=>{
    const el=document.createElement('div'); el.className='chip'+(state.phases.has(p)?' active':''); el.textContent=p+'æœŸ';
    el.onclick=()=>{ if(state.phases.has(p)) state.phases.delete(p); else state.phases.add(p); renderPhaseChips(); apply(); };
    host.appendChild(el);
  });
}
function updateList(){
  const data=getFiltered(), tb=document.querySelector('#listTbl tbody'); tb.innerHTML='';
  for(const d of data){
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${d.name}</td><td><span class="phase">${d.phase}</span></td><td>${d.addr}</td><td>${d.type}</td><td>${d.cat}</td><td>${d.price}</td><td>${asMeters(d.dist)}</td>`;
    tb.appendChild(tr);
  }
  document.getElementById('countRow').textContent = `å…± ${data.length} å®¶`;
}
// è½‰ç›¤
let currentAngle=0, labels=[]; function buildWheel(){
  const items=getFiltered().slice(); labels=items.map(d=>d.name);
  const canvas=document.getElementById('wheelCanvas'), ctx=canvas.getContext('2d'); const W=canvas.width,H=canvas.height; const cx=W/2,cy=H/2,r=W/2-16;
  ctx.clearRect(0,0,W,H); const n=Math.max(labels.length,1), slice=2*Math.PI/n;
  for(let i=0;i<n;i++){ const a0=i*slice+currentAngle,a1=a0+slice; const hue=(i*360/n+20)%360;
    ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,r,a0,a1); ctx.closePath(); ctx.fillStyle=`hsl(${hue} 65% 45%)`; ctx.fill();
    ctx.strokeStyle="rgba(0,0,0,.25)"; ctx.lineWidth=1.2; ctx.stroke();
    ctx.save(); ctx.translate(cx,cy); ctx.rotate(a0+slice/2); ctx.textAlign="right"; ctx.fillStyle="#fff"; ctx.font="14px ui-sans-serif, system-ui, -apple-system, 'Noto Sans TC'";
    ctx.fillText(labels[i]||"ï¼ˆç„¡ï¼‰", r-10, 4); ctx.restore();
  }
}
let spinning=false; function spin(){
  if(spinning || labels.length===0) return; spinning=true;
  const n=labels.length, slice=2*Math.PI/n; const targetIndex=Math.floor(Math.random()*n);
  const targetAngle=(3*Math.PI/2)-(targetIndex*slice+slice/2); const extraTurns=4+Math.floor(Math.random()*3); const finalAngle=targetAngle+extraTurns*2*Math.PI;
  const duration=3200+Math.random()*1200, start=performance.now(), startAngle=currentAngle;
  const animate=now=>{ const t=Math.min(1,(now-start)/duration), ease=1-Math.pow(1-t,3);
    currentAngle=startAngle+(finalAngle-startAngle)*ease; buildWheel();
    if(t<1) requestAnimationFrame(animate); else{ spinning=false; currentAngle=((currentAngle%(2*Math.PI))+2*Math.PI)%(2*Math.PI);
      let idx=Math.round(((3*Math.PI/2-currentAngle)/slice)-0.5); idx=((idx%n)+n)%n; const picked=labels[idx]; showResult(picked); } };
  requestAnimationFrame(animate);
}
function showResult(name){
  const item=getFiltered().find(d=>d.name===name) || DATA.find(d=>d.name===name);
  const host=document.getElementById('result'); if(!item){ host.textContent="ï¼ˆæ‰¾ä¸åˆ°é …ç›®ï¼‰"; return; }
  const mapQ=encodeURIComponent(`${item.name} ${item.addr}`), url=`https://www.google.com/maps/search/?api=1&query=${mapQ}`;
  const distLabel=state.myLoc? asMeters(haversine(state.myLoc, phaseCenters[item.phase])): "â€”";
  host.innerHTML = `<div class="tag">æŠ½ä¸­äº†</div>
    <div style="font-size:20px;margin:4px 0">${item.name}</div>
    <div class="muted">${item.addr}ã€€<span class="phase">${item.phase}æœŸ</span>ã€€ï½œ ${item.cat}ãƒ»${item.price} ï½œ è·é›¢ ${distLabel}</div>
    <div class="stack" style="margin-top:8px"><a class="btn" target="_blank" rel="noopener" href="${url}">åœ¨ Google åœ°åœ–é–‹å•Ÿ</a>
    <button class="btn" onclick="navigator.clipboard.writeText('${item.name} - ${item.addr}')">è¤‡è£½åç¨±ï¼‹åœ°å€</button>
    <button class="btn" onclick="spin()">ä¸æœå†æŠ½ä¸€æ¬¡</button></div>`;
}

// åŒ¯å‡º
function exportCSV(){
  const rows=[["é¤å»³","æœŸåˆ¥","åœ°å€","å‹æ…‹","å¯ç´ é£Ÿ","é¡åˆ¥","åƒ¹ä½","è·é›¢(m)"]]
    .concat(getFiltered().map(d=>[d.name,d.phase,d.addr,d.type,d.veg?"æ˜¯":"å¦",d.cat,d.price,d.dist?Math.round(d.dist):""]));
  const csv=rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(",")).join("\n");
  const url=URL.createObjectURL(new Blob([csv],{type:"text/csv;charset=utf-8;"}));
  const a=document.createElement('a'); a.href=url; a.download="taiyuan-food-list.csv"; a.click(); setTimeout(()=>URL.revokeObjectURL(url),3000);
}

// ç¶å®š
function apply(){ updateList(); buildWheel(); }
document.getElementById('btnApply').onclick=apply;
document.getElementById('btnSpin').onclick=spin;
document.getElementById('btnShuffle').onclick=()=>{ currentAngle=0; buildWheel(); };
document.getElementById('btnReset').onclick=()=>{
  state={ phases:new Set([1,2,3,5,6,8,9]), onlyMeals:false, onlyVeg:false, cat:"", price:"", myLoc:null, maxDist:1200, sortBy:"distance" };
  document.getElementById('onlyMeals').checked=false; document.getElementById('onlyVeg').checked=false;
  document.getElementById('q').value=""; document.getElementById('cat').value=""; document.getElementById('price').value="";
  document.getElementById('myPhase').value=""; document.getElementById('sortBy').value="distance"; document.getElementById('maxDist').value=1200;
  document.getElementById('maxDistLabel').textContent="â‰¤ 1200 m"; document.getElementById('myLocLabel').textContent="èµ·é»ï¼šæœªè¨­å®šï¼ˆè·é›¢æ’åºåŠŸèƒ½å—é™ï¼‰"; renderPhaseChips(); apply();
};
document.getElementById('onlyMeals').onchange=e=>{ state.onlyMeals=e.target.checked; apply(); };
document.getElementById('onlyVeg').onchange=e=>{ state.onlyVeg=e.target.checked; apply(); };
document.getElementById('cat').onchange=e=>{ state.cat=e.target.value; apply(); };
document.getElementById('price').onchange=e=>{ state.price=e.target.value; apply(); };
document.getElementById('sortBy').onchange=e=>{ state.sortBy=e.target.value; apply(); };
document.getElementById('maxDist').oninput=e=>{ state.maxDist=+e.target.value; document.getElementById('maxDistLabel').textContent = `â‰¤ ${state.maxDist} m`; apply(); };
document.getElementById('btnUseGPS').onclick=()=>{
  if(!navigator.geolocation){ alert("æ­¤ç€è¦½å™¨ä¸æ”¯æ´å®šä½ã€‚å¯æ”¹ç”¨ã€æˆ‘çš„æœŸåˆ¥ã€è¨­å®šèµ·é»ã€‚"); return; }
  navigator.geolocation.getCurrentPosition(pos=>{
    state.myLoc=[pos.coords.latitude, pos.coords.longitude];
    document.getElementById('myPhase').value="";
    document.getElementById('myLocLabel').textContent=`èµ·é»ï¼šGPS å·²è¨­å®šï¼ˆ${pos.coords.latitude.toFixed(5)}, ${pos.coords.longitude.toFixed(5)}ï¼‰`;
    apply();
  }, _=> alert("ç„¡æ³•å–å¾—å®šä½ï¼ˆéœ€è¦ HTTPS æˆ–æ¬Šé™è¢«æ‹’ï¼‰ã€‚å¯ç”¨ã€æˆ‘çš„æœŸåˆ¥ã€è¨­å®šèµ·é»ã€‚"), {enableHighAccuracy:true, timeout:8000, maximumAge:60000});
};
document.getElementById('myPhase').onchange=e=>{
  const p=+e.target.value;
  if(p){ state.myLoc=phaseCenters[p]; document.getElementById('myLocLabel').textContent=`èµ·é»ï¼š${p} æœŸä¸­å¿ƒé»ï¼ˆè¿‘ä¼¼ï¼‰`; }
  else{ state.myLoc=null; document.getElementById('myLocLabel').textContent="èµ·é»ï¼šæœªè¨­å®šï¼ˆè·é›¢æ’åºåŠŸèƒ½å—é™ï¼‰"; }
  apply();
};
document.getElementById('q').addEventListener('keydown',e=>{ if(e.key==="Enter") apply(); });

// init
renderPhaseChips(); apply();
</script>
</body>
</html>
